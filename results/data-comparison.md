---
title: "R Notebook"
output: 
  html_notebook:
    toc: true
---

This document serves to compare the data presented in Sydney's original XLSX 
file and the one generated by Sajeewa. He cleaned it up by inserting "unk" for
missing values. Because there was no file trail for this other than his own
comment, I will compare these two.





```r
library('tidyverse')
```

```
## Loading tidyverse: ggplot2
## Loading tidyverse: tibble
## Loading tidyverse: tidyr
## Loading tidyverse: readr
## Loading tidyverse: purrr
## Loading tidyverse: dplyr
```

```
## Conflicts with tidy packages ----------------------------------------------
```

```
## filter(): dplyr, stats
## lag():    dplyr, stats
```

```r
library('readxl')
library('assertr')
```


## Assertations

Of course, to make sure the data are cromulent, we want to ensure they live up to
our standards of what has been reported. For this, we will use the *assertr*
package, which lets us check our data in various ways. I'm taking the data
presented in the paper thus far to create the assertions.



```r
size_ranges <- 
"locus\trange\tn
5-2	318-324	4
6-2	483-495	3
7-2	158-174	7
8-3	244-270	7
9-2	360-382	9
12-2	214-222	5
17-3	342-363	7
20-3	280-282	2
55-4	153-216	10
110-4	370-386	5
114-4	339-416	10
"
sr <- read_tsv(size_ranges) %>%
  separate(range, c("lower", "upper"), sep = "-") # split range into lower and upper bounds
sr
```

```
## # A tibble: 11 × 4
##    locus lower upper     n
## *  <chr> <chr> <chr> <int>
## 1    5-2   318   324     4
## 2    6-2   483   495     3
## 3    7-2   158   174     7
## 4    8-3   244   270     7
## 5    9-2   360   382     9
## 6   12-2   214   222     5
## 7   17-3   342   363     7
## 8   20-3   280   282     2
## 9   55-4   153   216    10
## 10 110-4   370   386     5
## 11 114-4   339   416    10
```

```r
# Making the assertation string.
# To do this, we are using `sprintf()` to print the assert statement:
#   assert(within_bounds(lower, upper), `locus`)
# which means: "assert that the alleles (data) within this locus (variable) are
# within the defined range". 
# 
# The `apply()` function takes a matrix or data frame and applies a given function over each
# row (MARGIN = 1) or column (MARGIN = 2). In this case, we are specifying rows.
# 
# We then collapse all these statements with the pipe operator: %>%
# Then we add the name of the operation to the beginning
assrt_string <- apply(sr, MARGIN = 1, function(x){
    sprintf("  assert(within_bounds(%s, %s), `%s`)", x[2], x[3], x[1]) 
  }) %>% 
  paste(collapse = " %>%\n") %>%
  paste("assert_alleles_within_bounds <- .", ., sep = " %>%\n")
#
# now we can see what this statement looks like
cat(assrt_string)
```

```
## assert_alleles_within_bounds <- . %>%
##   assert(within_bounds(318, 324), `5-2`) %>%
##   assert(within_bounds(483, 495), `6-2`) %>%
##   assert(within_bounds(158, 174), `7-2`) %>%
##   assert(within_bounds(244, 270), `8-3`) %>%
##   assert(within_bounds(360, 382), `9-2`) %>%
##   assert(within_bounds(214, 222), `12-2`) %>%
##   assert(within_bounds(342, 363), `17-3`) %>%
##   assert(within_bounds(280, 282), `20-3`) %>%
##   assert(within_bounds(153, 216), `55-4`) %>%
##   assert(within_bounds(370, 386), `110-4`) %>%
##   assert(within_bounds(339, 416), `114-4`)
```

```r
# here, we evaluate it, making it available for us later on.
eval(parse(text = assrt_string)) 

YEARS <- c("2003", "2004", "2005", "2007", "2008", "2009", "2010", "2012")

STATE <- c("AU", "TS", "FR", "BL", "MX", "NE", "NY", "MN", "MI", "OR", 
           "WA", "CO", "WI", "ID", "CA", "ND")

HOST <- c("Merlot", "Pinto", "redkid", "Beryl", "Bunsi", "37", "38", 
          "11A", "cornell", "G122", "Orion", "PO7104", "PO7863", "WM31", 
          "GH", "BO7104", "Black", "Vista", "SR06233", "BL", "Fuji", "unk", 
          "Zorro", "PO7883", "Emerson", "Weihing", "Yellow")

check_data_cromulence <- . %>%
  chain_start() %>%
  verify(nrow(.) == 366) %>%          # 366 isolates
  verify(has_all_names(sr$locus)) %>% # Has all loci
  assert_alleles_within_bounds %>%    # each locus has alleles within bounds
  assert(in_set(YEARS), Year) %>%     # has all specified years
  assert(in_set(STATE), State) %>%    # has all specified States (incl. countries)
  assert(in_set(HOST), Host) %>%      # has all specified Hosts (incl. countries)
  chain_end(error_fun = warn_report)
```


## Reading in Sydney's data

Sydney's data is stored in excel format, so we have to use readxl to parse it.
First, we want to know what sheets exist.


```r
excel_sheets("../Analysis4 ForManu/A1_Copy of binned-genotypes_SE.xlsx")
```

```
## [1] "original"      "edited"        "GenAlex"       "replen est"   
## [5] "GenAlexBinned"
```

We will be using the GenAlexBinned sheet. From my talks with Sydney, this sheet
contains the SSR data binned into the expected allelels. Note, this sequence of
data input and cleaning was done iteratively and what you are seeing is the 
final result.

There are always quirks with the data when it's in excel. Often, there are too
many rows, so we have to remove them with `slice()`.

Quirks specific to thse data:

 - GenAlEx format has an extra header region that should be ignored
 - The loci are formatted like so: `110-4(F)`, where the `(F)` part is not 
   informative
 - The header for the strata has extra information
 

 

```r
syd <- read_excel("../Analysis4 ForManu/A1_Copy of binned-genotypes_SE.xlsx", 
                sheet = "GenAlexBinned", skip = 1) %>%
  select(-1) %>%                # removing first column, which is empty
  gather(locus, allele, -1) %>% # gather all loci into tidy columns
  mutate(locus = trimws(locus) %>% substr(1, nchar(.) - 3)) %>% # remove (F) designator
  mutate(allele = as.integer(allele)) %>% # force alleles to integers
  spread(locus, allele) %>%     # spread data out with individual loci in columns
  separate(iso_st_mcg_org_loc_yr_hst_cult_rep, 
           c("Isolate", "Severity", "MCG", "State", "Source", "Year", "Host"), 
           sep = "_") %>%
  mutate_if(is.character, trimws) %>% # Trim whitespace forom all character columns
  mutate(Severity = as.numeric(Severity)) %>%
  mutate(Source = ifelse(Source == "", "unk", Source)) %>%
  slice(-n()) %>% # remove last row
  arrange(Isolate) %>%
  check_data_cromulence
```

```
## There is 1 error:
## 
## - Column 'Host' violates assertion 'in_set(HOST)' 3 times
##   index  value
## 1    39 ExRico
## 2   263 B07104
## 3   317 PO7683
```

```
## Warning: assertr encountered errors
```

```r
syd
```

```
## # A tibble: 366 × 18
##    Isolate Severity   MCG State Source  Year  Host `110-4` `114-4` `12-2`
##      <chr>    <dbl> <chr> <chr>  <chr> <chr> <chr>   <int>   <int>  <int>
## 1      152      3.9     4    NE    unk  2003    GH     378     371    216
## 2      274      5.4    45    NE    unk  2003    GH     378     359    216
## 3      443      6.3     5    NY    unk  2003    GH     378     367    216
## 4      444      4.4     4    MN    wmn  2003  G122     378     371    216
## 5      445      4.7     4    MN    wmn  2003 Beryl     378     371    216
## 6      446      6.1     3    MI    wmn  2003 Beryl     386     359    216
## 7      447      5.5     5    MI    wmn  2003 Beryl     378     367    222
## 8      448      5.0     3    MI    wmn  2003 Beryl     386     359    216
## 9      449      5.2     3    MI    wmn  2003 Bunsi     386     367    216
## 10     450      5.3     5    MI    wmn  2003 Bunsi     378     367    216
## # ... with 356 more rows, and 8 more variables: `17-3` <int>,
## #   `20-3` <int>, `5-2` <int>, `55-4` <int>, `6-2` <int>, `7-2` <int>,
## #   `8-3` <int>, `9-2` <int>
```

## Reading in Sajeewa's data

These data can be read in via `reader::read_csv()`


```r
column_specification <- cols(
  Individual = col_character(),
  iso_st_mcg_org_loc_yr_hst = col_character(),
  `5-2(F)` = col_integer(),
  `6-2(F)` = col_integer(),
  `7-2(F)` = col_integer(),
  `8-3(H)` = col_integer(),
  `9-2(F)` = col_integer(),
  `12-2(H)` = col_integer(),
  `17-3(H)` = col_integer(),
  `20-3(F)` = col_integer(),
  `55-4(F)` = col_integer(),
  `110-4(H)` = col_integer(),
  `114-4(H)` = col_integer()
)
saj <- read_csv("../Analysis4 ForManu/A2_Copy4 EUR_AUS_forManu.csv", skip = 2, col_types = column_specification) %>%
  select(-1) %>%
  gather(locus, allele, -1) %>% # gather all loci into tidy columns
  mutate(locus = trimws(locus) %>% substr(1, nchar(.) - 3)) %>% # remove (F) designator
  spread(locus, allele) %>%     # spread data out with individual loci in columns
  separate(iso_st_mcg_org_loc_yr_hst, # Note: this corresponds closer to the initial data
           c("Isolate", "Severity", "MCG", "State", "Source", "Year", "Host"), 
           sep = "_") %>%
  mutate_if(is.character, trimws) %>% # Trim whitespace forom all character columns
  mutate(Severity = as.numeric(Severity)) %>%
  arrange(Isolate) %>%
  check_data_cromulence
```

```
## There is 1 error:
## 
## - Column 'Host' violates assertion 'in_set(HOST)' 2 times
##   index  value
## 1   263 B07104
## 2   317 PO7683
```

```
## Warning: assertr encountered errors
```

```r
saj
```

```
## # A tibble: 366 × 18
##    Isolate Severity   MCG State Source  Year  Host `110-4` `114-4` `12-2`
##      <chr>    <dbl> <chr> <chr>  <chr> <chr> <chr>   <int>   <int>  <int>
## 1      152      3.9     4    NE    unk  2003    GH     378     371    216
## 2      274      5.4    45    NE    unk  2003    GH     378     359    216
## 3      443      6.3     5    NY    unk  2003    GH     378     367    216
## 4      444      4.4     4    MN    wmn  2003  G122     378     371    216
## 5      445      4.7     4    MN    wmn  2003 Beryl     378     371    216
## 6      446      6.1     3    MI    wmn  2003 Beryl     386     359    216
## 7      447      5.5     5    MI    wmn  2003 Beryl     378     367    222
## 8      448      5.0     3    MI    wmn  2003 Beryl     386     359    216
## 9      449      5.2     3    MI    wmn  2003 Bunsi     386     367    216
## 10     450      5.3     5    MI    wmn  2003 Bunsi     378     367    216
## # ... with 356 more rows, and 8 more variables: `17-3` <int>,
## #   `20-3` <int>, `5-2` <int>, `55-4` <int>, `6-2` <int>, `7-2` <int>,
## #   `8-3` <int>, `9-2` <int>
```

## Comparison


We've sorted each data set by Isolate, so that means that we should expect them
to have the same data. The `setequal()` checks whether or not both data sets
have the same rows (in any order)


```r
dplyr::setequal(saj, syd)
```

```
## FALSE: Rows in x but not y: 366, 365, 363, 260, 364, 41, 40, 39, 38. Rows in y but not x: 366, 365, 364, 363, 260, 41, 39, 38, 40.
```

Okay, something's not cromulent here. We'll have to manaully inspect these:


```r
syddiff <- dplyr::setdiff(syd, saj)
sajdiff <- dplyr::setdiff(saj, syd)
the_difference <- bind_rows(syd = syddiff, saj = sajdiff, .id = "source") %>% arrange(Isolate)
head(the_difference, n = 20)
```

```
## # A tibble: 18 × 19
##    source Isolate Severity   MCG State Source  Year   Host `110-4` `114-4`
##     <chr>   <chr>    <dbl> <chr> <chr>  <chr> <chr>  <chr>   <int>   <int>
## 1     syd     496      5.1    83    TS    wmn  2004   G122     386     359
## 2     saj     496      5.1    83    AU    wmn  2004   G122     386     359
## 3     syd     499      5.6    85    TS    wmn  2004 ExRico     378     367
## 4     saj     499      5.6    85    AU    wmn  2004  Bunsi     378     367
## 5     syd     500      1.4    83    TS    wmn  2004  Beryl     374     367
## 6     saj     500      1.4    83    AU    wmn  2004  Beryl     374     367
## 7     syd     501      3.3    84    TS    wmn  2004  Beryl     374     359
## 8     saj     501      3.3    84    AU    wmn  2004  Beryl     374     359
## 9     saj     805      5.8    18    ND    stc  2010    unk     382     339
## 10    syd    805*      5.8    18    ND    stc  2010    unk     382     339
## 11    syd     966      4.5    33    BL   flds  2012    unk     386     371
## 12    saj     966      4.5    33    FR   flds  2012    unk     386     371
## 13    syd     967      5.8    34    BL   flds  2012    unk     386     339
## 14    saj     967      5.8    34    FR   flds  2012    unk     386     339
## 15    syd     968      4.2    34    BL   flds  2012    unk     370     339
## 16    saj     968      4.2    34    FR   flds  2012    unk     370     339
## 17    syd     970      5.2    35    BL   flds  2012    unk     382     371
## 18    saj     970      5.2    35    FR   flds  2012    unk     382     371
## # ... with 9 more variables: `12-2` <int>, `17-3` <int>, `20-3` <int>,
## #   `5-2` <int>, `55-4` <int>, `6-2` <int>, `7-2` <int>, `8-3` <int>,
## #   `9-2` <int>
```


## Conclusion

Both data sets failed the cromulence check in a common manner:

```
- Column 'Host' violates assertion 'in_set(HOST)' 2 times
  index  value
1   263 B07104
2   317 PO7683
```

These are the values I grabbed from the manuscript that could possibly match:

 - `PO7863`
 - `PO7883`
 - `BO7104` (The difference is that this is the letter "O" and above is the number "0")

Sydney's data set had an extra discrepancy, but that's noted in the difference
between data sets below:

1. Isolate 805 is flagged for some reason in Sydney's data set
2. Tasmania (TS, Sydney) has been changed to Australia (AU, Sajeewa)
3. Belgium (BL, Sydney) has been changed to France (FR, Sajeewa)
4. Host for isolate 499 has been changed from ExRico (Sydney) to Bunsi (Sajeewa)




## Session Information


```r
options(width = 100)
devtools::session_info()
```

```
## Session info ---------------------------------------------------------------------------------------
```

```
##  setting  value                       
##  version  R version 3.3.3 (2017-03-06)
##  system   x86_64, darwin13.4.0        
##  ui       X11                         
##  language (EN)                        
##  collate  en_US.UTF-8                 
##  tz       America/Chicago             
##  date     2017-03-30
```

```
## Packages -------------------------------------------------------------------------------------------
```

```
##  package     * version    date       source                          
##  assertr     * 2.0.0      2017-03-17 CRAN (R 3.3.2)                  
##  assertthat    0.1        2013-12-06 CRAN (R 3.2.0)                  
##  broom         0.4.2      2017-02-13 CRAN (R 3.3.2)                  
##  colorspace    1.3-2      2016-12-14 CRAN (R 3.3.2)                  
##  DBI           0.5-1      2016-09-10 CRAN (R 3.3.0)                  
##  devtools      1.12.0     2016-06-24 CRAN (R 3.3.0)                  
##  digest        0.6.12     2017-01-27 CRAN (R 3.3.2)                  
##  dplyr       * 0.5.0      2016-06-24 CRAN (R 3.3.0)                  
##  evaluate      0.10       2016-10-11 cran (@0.10)                    
##  ezknitr       0.6        2016-09-16 CRAN (R 3.3.0)                  
##  forcats       0.2.0      2017-01-23 CRAN (R 3.3.2)                  
##  foreign       0.8-67     2016-09-13 CRAN (R 3.3.0)                  
##  ggplot2     * 2.2.1      2016-12-30 CRAN (R 3.3.2)                  
##  gtable        0.2.0      2016-02-26 CRAN (R 3.2.3)                  
##  haven         1.0.0      2016-09-23 CRAN (R 3.3.0)                  
##  hms           0.3        2016-11-22 CRAN (R 3.3.2)                  
##  httr          1.2.1      2016-07-03 cran (@1.2.1)                   
##  jsonlite      1.3        2017-02-28 CRAN (R 3.3.2)                  
##  knitr       * 1.15.16    2017-03-29 Github (yihui/knitr@9f6a1c2)    
##  lattice       0.20-34    2016-09-06 CRAN (R 3.3.0)                  
##  lazyeval      0.2.0.9000 2016-07-01 Github (hadley/lazyeval@c155c3d)
##  lubridate     1.6.0      2016-09-13 CRAN (R 3.3.0)                  
##  magrittr      1.5        2014-11-22 CRAN (R 3.2.0)                  
##  memoise       1.0.0      2016-01-29 CRAN (R 3.2.3)                  
##  mnormt        1.5-5      2016-10-15 cran (@1.5-5)                   
##  modelr        0.1.0      2016-08-31 CRAN (R 3.3.0)                  
##  munsell       0.4.3      2016-02-13 CRAN (R 3.2.3)                  
##  nlme          3.1-131    2017-02-06 CRAN (R 3.3.2)                  
##  plyr          1.8.4      2016-06-08 CRAN (R 3.3.0)                  
##  psych         1.6.12     2017-01-08 CRAN (R 3.3.2)                  
##  purrr       * 0.2.2      2016-06-18 CRAN (R 3.3.0)                  
##  R.methodsS3   1.7.1      2016-02-16 CRAN (R 3.2.3)                  
##  R.oo          1.21.0     2016-11-01 CRAN (R 3.3.0)                  
##  R.utils       2.5.0      2016-11-07 CRAN (R 3.3.0)                  
##  R6            2.2.0      2016-10-05 cran (@2.2.0)                   
##  Rcpp          0.12.9     2017-01-14 CRAN (R 3.3.2)                  
##  readr       * 1.0.0      2016-08-03 CRAN (R 3.3.0)                  
##  readxl      * 0.1.1      2016-03-28 CRAN (R 3.3.0)                  
##  reshape2      1.4.2      2016-10-22 cran (@1.4.2)                   
##  rvest         0.3.2      2016-06-17 CRAN (R 3.3.0)                  
##  scales        0.4.1      2016-11-09 CRAN (R 3.3.2)                  
##  stringi       1.1.2      2016-10-01 CRAN (R 3.3.0)                  
##  stringr       1.2.0      2017-02-18 cran (@1.2.0)                   
##  tibble      * 1.2        2016-08-26 cran (@1.2)                     
##  tidyr       * 0.6.1      2017-01-10 CRAN (R 3.3.2)                  
##  tidyverse   * 1.1.1      2017-01-27 CRAN (R 3.3.2)                  
##  withr         1.0.2      2016-06-20 cran (@1.0.2)                   
##  xml2          1.1.1      2017-01-24 CRAN (R 3.3.2)
```

