---
title: "dbRDA analysis"
output: 
  html_notebook:
    toc: true
---


```{r setup, include = FALSE}
knitr::opts_knit$set(root.dir = PROJHOME)
```


This document serves to re-assess Sajeewa's dbRDA analysis with the repeat
lengths that have been modified to avoid inconsistent allele calls. 

Modification in this case means that a tiny amount has been added or subtracted
to the repeat length to ensure that the alleles are all unique after division.

Below is my attempt at reproduction of Sajeewa's analysis.

## Packages and Data

```{r, load_packages}
library('tidyverse')
library('poppr')
library('vegan')
library('ggrepel')
```


```{r, load_data}
load("data/sclerotinia_16_loci.rda")
setPop(dat)   <- ~Host/Source/Region/Year
setPop(dat11) <- ~Host/Source/Region/Year
dat11cc <- clonecorrect(dat11, ~Host/Source/Region/Year, keep = 1:4)
dat16cc <- clonecorrect(dat, ~Host/Source/Region/Year, keep = 1:4)
dat11cc
dat16cc
# environmental variables for dbRDA
stopifnot(identical(indNames(dat11cc), other(dat11cc)$meta$Isolate))
stopifnot(identical(indNames(dat16cc), other(dat16cc)$meta$Isolate))

makeENV <- function(DAT, CC){
  # Creating the data frame with severity
  META   <- select(other(DAT)$meta, -Isolate)
  STRATA <- select(strata(DAT), -MCG)
  MLL    <- data.frame(MLG = mll(DAT))
  sev    <- bind_cols(META, STRATA, MLL) %>%
    group_by(Host, Source, Year, Region, MLG) %>% 
    summarize(Severity = mean(Severity)) %>% # Get mean severity per MLG
    ungroup()
  # Ensuring the data is in the correct order
  META   <- select(other(CC)$meta, -Isolate)
  STRATA <- select(strata(CC), -MCG)
  MLL    <- data.frame(MLG = mll(CC))
  bind_cols(META, STRATA, MLL) %>% 
    left_join(sev)
}

ENV11 <- makeENV(dat11, dat11cc)
ENV11
stopifnot(identical(ENV11$MLG, mll(dat11cc)))
ENV11 <- select(ENV11, -MLG)
ENV16 <- makeENV(dat, dat16cc)
ENV16
stopifnot(identical(ENV11$MLG, mll(dat11cc)))
ENV16 <- select(ENV16, -MLG)
```


## Function to tie everything together


```{r}
choose_dbrda <- function(bdist, ENV, CHOOSER = "ordistep", ...){
  mod0  <- capscale(bdist ~ 1, data = ENV, add = TRUE)
  mod1  <- capscale(bdist ~ ., data = ENV, add = TRUE)
  CHOOSER <- match.fun(CHOOSER)
  the_model <- CHOOSER(mod0, scope = formula(mod1), ...)
  return(the_model)
}
arrowMul <- function(arrows, data, at = c(0, 0), fill = 0.75) {
    u <- c(range(data[,1], range(data[,2])))
    u <- u - rep(at, each = 2)
    r <- c(range(arrows[, 1], na.rm = TRUE), range(arrows[, 2], na.rm = TRUE))
    rev <- sign(diff(u))[-2]
    if (rev[1] < 0)
        u[1:2] <- u[2:1]
    if (rev[2] < 0)
        u[3:4] <- u[4:3]
    u <- u/r
    u <- u[is.finite(u) & u > 0]
    fill * min(u)
}
plot_dbrda <- function(db){
  dbsum     <- scores(db, display = c("cn", "bp", "sites"), scaling = "sites")
  Centroids <- as.data.frame(dbsum$centroids)
  Centroids <- rownames_to_column(Centroids, var = "cent_type")
  Centroids <- mutate_(Centroids, .dots = list(Length = ~sqrt(CAP1^2 * CAP2^2)))
  # Centroids
  SampleCentroids <- rownames_to_column(data.frame(dbsum$sites), var = "isolate_names")
  
  mul     <- arrowMul(dbsum$biplot[, 1:2], dbsum$sites) * 10
  Arrows  <- data.frame(dbsum$biplot * mul)
  Arrows  <- rownames_to_column(Arrows, var = "class")
  Arrows  <- mutate_(Arrows, .dots = list(Length = ~sqrt(CAP1^2 * CAP2^2)))
  Arrows  <- arrange(Arrows, Length)
  Arrows  <- top_n(Arrows, 8)
  ggplot(DecendCentro, aes(x = CAP1, y = CAP2))+
   geom_point(data = site_centroids, alpha = 1/2, fill = "dark orange", color = "black", size = 2.5, pch = 21)+
   coord_cartesian() +
   geom_segment(aes(x = 0, xend = CAP1, 
                    y = 0, yend = CAP2),
                arrow = arrow(length = unit(0.3, "cm")), 
                data = Arrows
                ) + 
   geom_label_repel(aes(x = CAP1, y = CAP2, label = class), data = Arrows)
}
```


# Calculations

```{r rda_calculation, cache = TRUE}
dat11cc.bruvo <- dat11cc %>% bruvo.dist(replen = other(.)$REPLEN)
cap11cc       <- choose_dbrda(dat11cc.bruvo, ENV = ENV11, CHOOSER = "ordistep")
dat16cc.bruvo <- dat16cc %>% bruvo.dist(replen = other(.)$REPLEN)
cap16cc       <- choose_dbrda(dat16cc.bruvo, ENV = ENV16, CHOOSER = "ordistep")
```

```{r}
plot_dbrda(cap11cc) + theme_bw() + theme(text = element_text(size = 14))
plot_dbrda(cap16cc) + theme_bw() + theme(text = element_text(size = 14))
```

